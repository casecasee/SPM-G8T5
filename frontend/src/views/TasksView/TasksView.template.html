<div class="tasks-page">
  <div class="tasks-header">
    <h2>Tasks</h2>
    <div class="header-buttons">
      <Button v-if="currentTab === 'my'" label="+ Add Task" class="add-top-btn" @click="openAdd" />
      <Button class="add-top-btn" label="üìÖ Timeline View" @click="goToTimeline" />

      <!-- Filter Dropdown -->
      <div v-if="currentTab !== 'report'" class="header-filters">
        <Dropdown v-model="taskFilter" :options="filterOptions" optionLabel="label" optionValue="value"
          placeholder="Filter tasks..." class="filter-dropdown" />
      </div>
    </div>
  </div>

  <!-- Tabs visible to all users -->
  <div class="tabs">
    <button :class="['tab', currentTab==='my' ? 'active' : '']" @click="currentTab='my'">My Tasks</button>
    <button :class="['tab', currentTab==='team' ? 'active' : '']" @click="currentTab='team'" v-if="canViewTeamTasks">Team's Tasks</button>
    <button :class="['tab', currentTab==='departments' ? 'active' : '']" @click="currentTab='departments'" v-if="isSeniorManagerOrHR">All Departments</button>
  </div>

  <!-- Team search bar -->
<div v-if="currentTab==='team'" class="team-search-section">
  <!-- Search bar -->
  <InputText v-model="teamSearch" placeholder="Search employee by name" class="input-field" />

  <!-- Employee grid -->
  <div class="employee-grid">
    <div
      v-for="emp in filteredEmployeesForTeam.length ? filteredEmployeesForTeam : availableEmployees.filter(e => e.employee_id !== currentEmployeeId)"
      :key="emp.employee_id"
      class="employee-card"
      :class="teamSelectedEmployeeId === emp.employee_id ? 'selected' : ''"
      @click="teamSelectedEmployeeId = emp.employee_id"
    >
      <div class="employee-avatar">
        <i class="pi pi-user" style="font-size:1.2rem;"></i>
      </div>
      <div class="employee-name">{{ emp.employee_name }}</div>
      <div class="employee-role">{{ emp.role }}</div>
    </div>
  </div>
</div>

<!-- Department selection for Senior Managers and HR -->
<div v-if="isSeniorManagerOrHR && currentTab==='departments'" class="department-section">
  <!-- Department selection -->
  <div class="department-selection">
    <h3>Select Department</h3>
    <div class="department-grid">
      <div v-for="dept in departments" :key="dept" class="department-card"
        :class="selectedDepartment === dept ? 'selected' : ''" @click="selectDepartment(dept)">
        <div class="department-icon">
          <i class="pi pi-building" style="font-size:1.5rem;"></i>
        </div>
        <div class="department-name">{{ dept }}</div>
      </div>
    </div>
  </div>

  <div v-if="selectedDepartment" class="employee-selection">
    <h3>{{ selectedDepartment }} Employees</h3>
    <!-- Search bar -->
    <InputText v-model="departmentSearch" placeholder="Search employee by name" class="input-field" />

    <!-- Employee grid -->
    <div class="employee-grid">
      <div
        v-for="emp in filteredEmployeesForDepartment.length ? filteredEmployeesForDepartment : departmentEmployees.filter(e => e.employee_id !== currentEmployeeId)"
        :key="emp.employee_id" class="employee-card"
        :class="departmentSelectedEmployeeId === emp.employee_id ? 'selected' : ''"
        @click="selectDepartmentEmployee(emp.employee_id)">
        <div class="employee-avatar">
          <i class="pi pi-user" style="font-size:1.2rem;"></i>
        </div>
        <div class="employee-name">{{ emp.employee_name }}</div>
        <div class="employee-role">{{ emp.role }}</div>
      </div>
    </div>
  </div>
</div>

<div v-if="currentTab !== 'report' && currentTab !== 'individual_report'" class="tasks-container">

    <!-- High Priority Tasks -->
    <div v-if="tasksByPriority.high.length > 0" class="priority-section">
      <div class="priority-header high-priority">
        <i class="pi pi-clock"></i>
        <span>High Priority (Range 8 - 10)</span>
        <span class="task-count">{{ tasksByPriority.high.length }}</span>
      </div>
      <div class="tasks-grid">
        <Card v-for="task in tasksByPriority.high" :key="task.id" class="task-card" :class="{'task-overdue': isOverdue(task)}" @click="openDetails(task)">
          <template #title>
            <div class="task-title-row">
              <span>{{ task.name }}</span>
            </div>
          </template>
          <template #content>
            <p class="desc">{{ task.description }}</p>
            <p v-if="isOverdue(task)" class="overdue-label">‚ö†Ô∏è Overdue</p>
            <p class="meta"><i class="pi pi-calendar-times"></i> {{ formatDate(task.due_date) }} <span class="relative-time">({{ formatDateRelative(task.due_date) }})</span></p>
            <p v-if="task.start_date" class="meta"><i class="pi pi-calendar-plus"></i> Started: {{ formatDate(task.start_date) }}</p>
            <Dropdown
                v-if="isOwnerOrCollaborator(task)"
                v-model="task.status"
                :options="getStatusOptionsForTask(task)"
                optionLabel="label"
                optionValue="value"
                class="status-pill-dropdown"
                :class="getStatusClass(task.status)"
                @change="updateTaskStatus(task, task.status)"
                @click.stop
              />
            <p class="meta">Owner: <b>{{ getOwnerName(task.owner) || currentEmployeeName }}</b></p>
            <p class="meta">Collaborators: <b>{{ getCollaboratorNames(task.collaborators) || 'None' }}</b></p>
            <div v-if="task.recurrence" class="recurrence-badge">
              <i class="pi pi-refresh"></i>
              {{ getRecurrenceLabelFromDays(task.recurrence) }}
            </div>
          </template>
        </Card>
      </div>
    </div>

    <!-- Medium Priority Tasks -->
    <div v-if="tasksByPriority.medium.length > 0" class="priority-section">
      <div class="priority-header medium-priority">
        <i class="pi pi-clock"></i>
        <span>Medium Priority (Range 5 - 7)</span>
        <span class="task-count">{{ tasksByPriority.medium.length }}</span>
      </div>
      <div class="tasks-grid">
        <Card v-for="task in tasksByPriority.medium" :key="task.id" class="task-card" :class="{'task-overdue': isOverdue(task)}" @click="openDetails(task)">
          <template #title>
            <div class="task-title-row">
              <span>{{ task.name }}</span>
            </div>
          </template>
          <template #content>
            <p class="desc">{{ task.description }}</p>
            <p v-if="isOverdue(task)" class="overdue-label">‚ö†Ô∏è Overdue</p>
            <p class="meta"><i class="pi pi-calendar-times"></i> {{ formatDate(task.due_date) }} <span class="relative-time">({{ formatDateRelative(task.due_date) }})</span></p>
            <p v-if="task.start_date" class="meta"><i class="pi pi-calendar-plus"></i> Started: {{ formatDate(task.start_date) }}</p>
            <Dropdown
                v-if="isOwnerOrCollaborator(task)"
                v-model="task.status"
                :options="getStatusOptionsForTask(task)"
                optionLabel="label"
                optionValue="value"
                class="status-pill-dropdown"
                :class="getStatusClass(task.status)"
                @change="updateTaskStatus(task, task.status)"
                @click.stop
              />
            <p class="meta">Owner: <b>{{ getOwnerName(task.owner) || currentEmployeeName }}</b></p>
            <p class="meta">Collaborators: <b>{{ getCollaboratorNames(task.collaborators) || 'None' }}</b></p>
            <div v-if="task.recurrence" class="recurrence-badge">
              <i class="pi pi-refresh"></i>
              {{ getRecurrenceLabelFromDays(task.recurrence) }}
            </div>
          </template>
        </Card>
      </div>
    </div>

    <!-- Low Priority Tasks -->
    <div v-if="tasksByPriority.low.length > 0" class="priority-section">
      <div class="priority-header low-priority">
        <i class="pi pi-check-circle"></i>
        <span>Low Priority (Range 1 - 4)</span>
        <span class="task-count">{{ tasksByPriority.low.length }}</span>
      </div>
      <div class="tasks-grid">
        <Card v-for="task in tasksByPriority.low" :key="task.id" class="task-card" :class="{ 'task-overdue': isOverdue(task) }" @click="openDetails(task)">
          <template #title>
            <div class="task-title-row">
              <span>{{ task.name }}</span>
            </div>
          </template>
          <template #content>
            <p class="desc">{{ task.description }}</p>
            <p v-if="isOverdue(task)" class="overdue-label">‚ö†Ô∏è Overdue</p>
            <p class="meta"><i class="pi pi-calendar-times"></i> {{ formatDate(task.due_date) }} <span class="relative-time">({{ formatDateRelative(task.due_date) }})</span></p>
            <p v-if="task.start_date" class="meta"><i class="pi pi-calendar-plus"></i> Started: {{ formatDate(task.start_date) }}</p>
            <Dropdown
                v-if="isOwnerOrCollaborator(task)"
                v-model="task.status"
                :options="getStatusOptionsForTask(task)"
                optionLabel="label"
                optionValue="value"
                class="status-pill-dropdown"
                :class="getStatusClass(task.status)"
                @change="updateTaskStatus(task, task.status)"
                @click.stop
              />
            <p class="meta">Owner: <b>{{ getOwnerName(task.owner) || currentEmployeeName }}</b></p>
            <p class="meta">Collaborators: <b>{{ getCollaboratorNames(task.collaborators) || 'None' }}</b></p>
            <div v-if="task.recurrence" class="recurrence-badge">
              <i class="pi pi-refresh"></i>
              {{ getRecurrenceLabelFromDays(task.recurrence) }}
            </div>
          </template>
        </Card>
      </div>
    </div>
  </div>
  
    <!-- No tasks message -->
    <div v-if="shouldShowNoTasksMessage" class="no-tasks">
      <i class="pi pi-inbox"></i>
      <p>No tasks found</p>
    </div>
</div>

<Dialog v-model:visible="showModal" modal
  :header="isEditing && !selectedTask ? 'New Task' : (isEditing ? 'Edit Task' : 'Task Details')" class="clean-modal">
  <form @submit.prevent="() => {}">
    <div class="modal-content">
      <!-- Basic Information Section -->
      <div class="form-section">
        <h3 class="section-title">Basic Information</h3>

        <!-- Validation Error Summary (Parent Task Only) -->
        <div v-if="showValidationErrors && Object.keys(formErrors).some(key => !key.startsWith('subtask_'))"
          class="validation-summary">
          <div class="validation-icon">‚ö†Ô∏è</div>
          <div class="validation-content">
            <h4>{{ formErrors.backend ? 'Error' : 'Please fill in the following fields:' }}</h4>
            <ul>
              <template v-for="(error, field) in formErrors" :key="field">
                <li v-if="!field.startsWith('subtask_')">{{ error }}</li>
              </template>
            </ul>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Task Name *</label>
            <template v-if="isEditing || !selectedTask">
              <InputText v-model="taskForm.name" :class="['form-input', { 'error': getFieldError('name') }]"
                :disabled="!canEdit(selectedTask)" placeholder="Enter task name" data-field="name" />
              <div v-if="getFieldError('name')" class="field-error">{{ getFieldError('name') }}</div>
            </template>
            <template v-else>
              <div class="form-display">{{ taskForm.name }}</div>
            </template>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Description *</label>
            <template v-if="isEditing || !selectedTask">
              <Textarea v-model="taskForm.description" rows="3"
                :class="['form-input', { 'error': getFieldError('description') }]" :disabled="!canEdit(selectedTask)"
                placeholder="Enter task description" data-field="description" />
              <div v-if="getFieldError('description')" class="field-error">{{ getFieldError('description') }}</div>
            </template>
            <template v-else>
              <div class="form-display">{{ taskForm.description || 'No description' }}</div>
            </template>
          </div>
        </div>

        <div class="form-row form-row-3">
          <div class="form-group">
            <label class="form-label">Due Date *</label>
            <template v-if="isEditing || !selectedTask">
              <input type="datetime-local" v-model="taskForm.due_date" :min="minDate"
                :class="['form-input', { 'error': getFieldError('due_date') }]" :disabled="!canEdit(selectedTask)"
                data-field="due_date" />
              <div v-if="getFieldError('due_date')" class="field-error">{{ getFieldError('due_date') }}</div>
            </template>
            <template v-else>
              <div class="form-display">{{ formatDate(taskForm.due_date) }}</div>
            </template>
          </div>

          <div class="form-group">
            <label class="form-label">Start Date</label>
            <div class="form-display">{{ formatDate(taskForm.start_date) || 'Not started' }}</div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Status</label>
            <div class="form-display status-display" :class="getStatusClass(taskForm.status)">{{ taskForm.status }}
            </div>
          </div>
        </div>

        <div class="form-row form-row-3">
          <div class="form-group">
            <label class="form-label">Priority *</label>
            <template v-if="isEditing || !selectedTask">
              <Dropdown v-model="taskForm.priority" :options="priorityOptions" optionLabel="label" optionValue="value"
                :class="['form-input', { 'error': getFieldError('priority') }]" :disabled="!canEdit(selectedTask)"
                placeholder="Select priority..." data-field="priority" />
              <div v-if="getFieldError('priority')" class="field-error">{{ getFieldError('priority') }}</div>
            </template>
            <template v-else>
              <div class="form-display priority-display" :class="getPriorityClass(taskForm.priority)">P{{
                taskForm.priority }}</div>
            </template>
          </div>
          
          <div class="form-group">
            <!-- Empty div for spacing -->
          </div>
          
          <div class="form-group">
            <!-- Empty div for spacing -->
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Project</label>
            <template v-if="isEditing || !selectedTask">
              <Dropdown v-model="taskForm.project_id" :options="projectOptions" optionLabel="label" optionValue="value"
                class="form-input" placeholder="Select project" />
            </template>
            <template v-else>
              <div class="form-display">{{ getProjectLabelById(taskForm.project_id) }}</div>
            </template>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Recurrence</label>
            <template v-if="isEditing || !selectedTask">
              <div class="recurrence-fields">
                <Dropdown v-model="taskForm.recurrence_unit" :options="recurrenceUnitOptions" optionLabel="label"
                  optionValue="value" class="form-input recurrence-unit" placeholder="Select recurrence type..."
                  data-field="recurrence_unit" />
                <InputText v-if="taskForm.recurrence_unit && taskForm.recurrence_unit !== 'none'"
                  v-model.number="taskForm.recurrence_frequency" type="number" min="1"
                  class="form-input recurrence-frequency" placeholder="Frequency" data-field="recurrence_frequency" />
              </div>
              <div v-if="getFieldError('recurrence_frequency')" class="field-error">{{
                getFieldError('recurrence_frequency') }}</div>
            </template>
            <template v-else>
              <div class="form-display">
                <span v-if="taskForm.recurrence_unit && taskForm.recurrence_unit !== 'none'" class="recurrence-badge">
                  <i class="pi pi-refresh"></i>
                  {{ getRecurrenceLabel(taskForm.recurrence_unit, taskForm.recurrence_frequency) }}
                </span>
                <span v-else>No recurrence</span>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Assignment Section -->
      <div class="form-section assignment-section">
        <h3 class="section-title">
          Task Assignment
        </h3>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Owner</label>
            <div v-if="canAssignTasks() && isEditing && selectedTask" class="assignment-notice">
              <label>You are assigning this task to a team member. The selected person will become the new
                owner.</label>
            </div>
            <template v-if="canAssignTasks() && isEditing && selectedTask">
              <Dropdown v-model="taskForm.owner" :options="ownerAssignmentList" optionLabel="display_label"
                optionValue="employee_id" class="form-input assignment-dropdown" :disabled="!canEdit(selectedTask)"
                placeholder="Select new owner..." data-field="owner" filter
                filterBy="display_label,employee_name,role,team,department" />
            </template>
            <template v-else>
              <div class="form-display">{{ getOwnerName(taskForm.owner) || currentEmployeeName }}</div>
            </template>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Collaborators</label>
            <template v-if="isEditing || !selectedTask">
              <MultiSelect v-model="taskForm.collaborators"
                :options="employeeDisplayList.filter(emp => emp.employee_id !== taskForm.owner)"
                optionLabel="display_label" optionValue="employee_id" class="form-input"
                :disabled="!canEdit(selectedTask)" placeholder="Select collaborators..." filter
                filterBy="display_label,employee_name,role,team,department" />
            </template>
            <template v-else>
              <div class="form-display">{{ getCollaboratorNames(taskForm.collaborators) || 'None' }}</div>
            </template>
          </div>
        </div>
      </div>

      <!-- Attachments Section -->
      <div class="form-section">
        <h3 class="section-title">Attachments</h3>

        <div class="form-row">
          <div class="form-group">
            <template v-if="isEditing || !selectedTask">
              <FileUpload ref="fileUploadRef" mode="basic" accept=".pdf" :multiple="true" chooseLabel="Upload"
                :auto="false" :customUpload="true" @select="handleMainTaskAttachment"
                :disabled="selectedTask && isCollaboratorOnly(selectedTask)" class="file-upload" />
              <div v-if="taskForm.attachments.length > 0" class="file-list">
                <div v-for="(file, index) in taskForm.attachments" :key="index" class="file-item">
                  <a v-if="file.url" :href="file.url" target="_blank" class="file-link">
                    <i class="pi pi-paperclip"></i> {{ file.name }}
                  </a>
                  <span v-else class="file-name pending-upload">
                    <i class="pi pi-clock"></i> {{ file.name }} <small>(uploading...)</small>
                  </span>
                  <Button icon="pi pi-times" class="p-button-danger p-button-text p-button-sm file-remove"
                    @click="removeMainTaskAttachment(index)" v-if="isEditing || !selectedTask" />
                </div>
              </div>
            </template>
            <template v-else>
              <div v-if="taskForm.attachments.length > 0" class="file-list">
                <div v-for="(file, index) in taskForm.attachments" :key="index" class="file-item">
                  <a :href="file.url" target="_blank" class="file-link">
                    <i class="pi pi-paperclip"></i> {{ file.name }}
                  </a>
                </div>
              </div>
              <div v-else class="form-display">No attachments</div>
            </template>
          </div>
        </div>
      </div>

      <!-- Comments Section -->
      <div class="form-section">
        <h3 class="section-title">Comments</h3>

        <div v-if="commentError" class="comment-error">{{ commentError }}</div>

        <div class="comments-list" v-if="comments.length > 0">
          <div class="comment-item" v-for="c in comments" :key="c.id">
            <div class="comment-content">
              <div class="comment-meta">
                <span class="author">{{ getOwnerName(c.author_id) }} (#{{ c.author_id }})</span>
                <span class="timestamp">{{ new Date(c.created_at || c.updated_at).toLocaleString() }}</span>
              </div>
              <div v-if="editingCommentId === c.id" class="comment-edit">
                <Textarea v-model="editingContent" rows="2" class="form-input" />
                <div class="comment-actions">
                  <Button label="Save" type="button" class="p-button-sm" @click="saveEditComment(c.id)" />
                  <Button label="Cancel" type="button" class="p-button-text p-button-sm" @click="cancelEditComment" />
                </div>
              </div>
              <div v-else class="comment-text">
                {{ c.content }}
                <div v-if="(c.attachments || []).length" class="comment-attachments">
                  <a v-for="a in c.attachments" :key="a.id || a.filename"
                    :href="`http://localhost:5002${a.url || '/attachments/' + a.filename}`" target="_blank"
                    rel="noopener" class="attachment-link">
                    {{ a.original_name || a.filename }}
                  </a>
                </div>
              </div>
            </div>
            <div class="comment-ops"
              v-if="(isOwnerOrCollaborator(selectedTask) || (sessionStorage.getItem('role') || '').toLowerCase() !== 'staff') && isEditing">
              <Button label="Edit" type="button" class="p-button-text p-button-sm" @click="startEditComment(c)" />
              <Button label="Delete" type="button" class="p-button-danger p-button-text p-button-sm"
                @click="deleteComment(c.id)" />
            </div>
          </div>
        </div>
        <div v-else class="no-comments">No comments yet</div>

        <div class="comment-new">
          <div class="comment-input-wrapper">
            <Textarea v-model="newComment" rows="2" class="form-input" placeholder="Write a comment..."
              @input="onCommentInput" @keydown.down.prevent="moveMentionSelection(1)"
              @keydown.up.prevent="moveMentionSelection(-1)" @keydown.enter.prevent="handleCommentEnter"
              @blur="hideMentionList" />
            <div v-if="showMentionList && filteredMentionable.length > 0" class="mention-list">
              <div v-for="(u, idx) in filteredMentionable" :key="u.employee_id"
                :class="['mention-item', idx === mentionHighlighted ? 'active' : '']"
                @mousedown.prevent="insertMention(u)">
                <span class="mention-name">{{ u.employee_name }}</span>
                <span class="mention-role">({{ u.role }})</span>
              </div>
            </div>
          </div>
          <FileUpload mode="basic" name="attachment" url="http://localhost:5002/upload-attachment"
            :withCredentials="true" :auto="true" multiple accept=".pdf,.png,.jpg,.jpeg" :maxFileSize="16777216"
            :showUploadButton="false" :showCancelButton="false" chooseLabel="Attach File"
            @upload="onCommentFileUploaded" class="comment-file-upload" />
          <div class="attached-files" v-if="newCommentAttachments.length">
            <div v-for="(f, i) in newCommentAttachments" :key="i" class="attached-file">
              <span>{{ f.original_name || f.filename }}</span>
              <Button type="button" class="p-button-danger p-button-text p-button-sm"
                @click="removeNewAttachment(i)">Remove</Button>
            </div>
          </div>
          <div class="comment-actions">
            <Button label="Add Comment" type="button" @click="addComment" :disabled="!newComment.trim()"
              class="add-comment-btn" />
          </div>
        </div>
      </div>

      <!-- Subtasks Section -->
      <div class="form-section">
        <div class="subtasks-header">
          <h3 class="section-title">Subtasks</h3>
          <Button v-if="isEditing || !selectedTask" icon="pi pi-plus" label="Add Subtask" class="add-subtask-btn"
            @click="toggleSubtaskForm" />
        </div>

        <!-- Progress Bar -->
        <div v-if="subtasks.length > 0" class="subtask-progress">
          <div class="progress-header">
            <span class="progress-title">Progress</span>
            <span class="progress-stats">{{ subtaskProgress.completed }}/{{ subtaskProgress.total }}
              completed</span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar">
              <div class="progress-fill" :style="{ width: subtaskProgress.percentage + '%' }"></div>
            </div>
            <span class="progress-percentage">{{ subtaskProgress.percentage }}%</span>
          </div>
        </div>

        <!-- Subtask Form -->
        <div v-if="showSubtaskForm && (isEditing || !selectedTask)" class="subtask-form">
          <div v-if="showValidationErrors && Object.keys(formErrors).some(key => key.startsWith('subtask_'))"
            class="validation-summary">
            <div class="validation-icon">‚ö†Ô∏è</div>
            <div class="validation-content">
              <h4>Please fill in the following fields:</h4>
              <ul>
                <template v-for="(error, field) in formErrors" :key="field">
                  <li v-if="field.startsWith('subtask_')">{{ error }}</li>
                </template>
              </ul>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Subtask Name *</label>
              <InputText v-model="newSubtask.name" placeholder="Enter subtask name"
                :class="['form-input', { 'error': getFieldError('subtask_name') }]" data-field="subtask_name" />
              <div v-if="getFieldError('subtask_name')" class="field-error">{{ getFieldError('subtask_name') }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Description *</label>
              <Textarea v-model="newSubtask.description" placeholder="Enter description" rows="2"
                :class="['form-input', { 'error': getFieldError('subtask_description') }]"
                data-field="subtask_description" />
              <div v-if="getFieldError('subtask_description')" class="field-error">{{
                getFieldError('subtask_description') }}</div>
            </div>
          </div>

          <div class="form-row form-row-3">
            <div class="form-group">
              <label class="form-label">Due Date *</label>
              <input type="datetime-local" v-model="newSubtask.due_date" :min="subtaskMinDate" :max="subtaskMaxDate"
                :class="['form-input', { 'error': getFieldError('subtask_due_date') }]" data-field="subtask_due_date" />
              <div v-if="getFieldError('subtask_due_date')" class="field-error">{{ getFieldError('subtask_due_date')
                }}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <div class="form-display status-display" :class="getStatusClass(newSubtask.status)">{{
                newSubtask.status }}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Priority *</label>
              <Dropdown v-model="newSubtask.priority" :options="priorityOptions" optionLabel="label" optionValue="value"
                :class="['form-input', { 'error': getFieldError('subtask_priority') }]" data-field="subtask_priority"
                placeholder="Select priority..." />
              <div v-if="getFieldError('subtask_priority')" class="field-error">{{ getFieldError('subtask_priority')
                }}</div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Assign to *</label>
              <Dropdown v-model="newSubtask.owner" :options="subtaskOwnerList" optionLabel="display_label"
                optionValue="employee_id" :class="['form-input', { 'error': getFieldError('subtask_owner') }]"
                :disabled="!canEdit(selectedTask)" placeholder="Select owner..." data-field="subtask_owner" filter
                filterBy="display_label,employee_name,role,team,department" />
              <div v-if="getFieldError('subtask_owner')" class="field-error">{{ getFieldError('subtask_owner') }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Collaborators</label>
              <MultiSelect v-model="newSubtask.collaborators"
                :options="subtaskOwnerList.filter(emp => emp.employee_id !== newSubtask.owner)"
                optionLabel="display_label" optionValue="employee_id" class="form-input"
                :disabled="!canEdit(selectedTask)" placeholder="Select collaborators..." filter
                filterBy="display_label,employee_name,role,team,department" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Attachments</label>
              <FileUpload ref="subtaskFileUploadRef" mode="basic" accept=".pdf" :multiple="true" chooseLabel="Upload"
                :auto="false" :customUpload="true" @select="handleSubtaskAttachment" class="file-upload" />
              <div v-if="newSubtask.attachments.length > 0" class="file-list">
                <div v-for="(file, index) in newSubtask.attachments" :key="index" class="file-item">
                  <a v-if="file.url" :href="file.url" target="_blank" class="file-link">
                    <i class="pi pi-paperclip"></i> {{ file.name }}
                  </a>
                  <span v-else class="file-name pending-upload">
                    <i class="pi pi-clock"></i> {{ file.name }} <small>(uploading...)</small>
                  </span>
                  <Button icon="pi pi-times" class="p-button-danger p-button-text p-button-sm file-remove"
                    @click="removeSubtaskAttachment(index)" />
                </div>
              </div>
            </div>
          </div>

          <div class="subtask-form-actions">
            <Button label="Add Subtask" type="button" @click="addSubtask" class="add-subtask-confirm-btn" />
            <Button label="Cancel" type="button" @click="toggleSubtaskForm" class="p-button-text cancel-subtask-btn" />
          </div>
        </div>

        <!-- Subtasks List -->
        <div v-if="subtasks.length > 0" class="subtasks-list">
          <div v-for="(subtask, index) in subtasks" :key="subtask.id || index" class="subtask-item">
            <div class="subtask-content">
              <!-- Editing Mode -->
              <template v-if="isEditingSubtask(subtask)">
                <div class="subtask-edit-form">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Subtask Name *</label>
                      <InputText v-model="subtask.name" placeholder="Enter subtask name" class="form-input" />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Description *</label>
                      <Textarea v-model="subtask.description" placeholder="Enter description" rows="2"
                        class="form-input" />
                    </div>
                  </div>

                  <div class="form-row form-row-3">
                    <div class="form-group">
                      <label class="form-label">Due Date *</label>
                      <input type="datetime-local" v-model="subtask.due_date" :min="subtaskMinDate"
                        :max="subtaskMaxDate" class="form-input" />
                    </div>
                    <div class="form-group">
                      <label class="form-label">Status</label>
                      <div class="form-display status-display" :class="getStatusClass(subtask.status)">{{
                        subtask.status
                        }}</div>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Priority *</label>
                      <Dropdown v-model="subtask.priority" :options="priorityOptions" optionLabel="label"
                        optionValue="value" class="form-input" />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Assign to</label>
                      <Dropdown v-model="subtask.owner" :options="subtaskOwnerList" optionLabel="display_label"
                        optionValue="employee_id" class="form-input" placeholder="Select owner..." filter
                        filterBy="display_label,employee_name,role,team,department" />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Collaborators</label>
                      <MultiSelect v-model="subtask.collaborators"
                        :options="subtaskOwnerList.filter(emp => emp.employee_id !== subtask.owner)"
                        optionLabel="display_label" optionValue="employee_id" class="form-input"
                        placeholder="Select collaborators..." filter
                        filterBy="display_label,employee_name,role,team,department" />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Attachments</label>
                      <FileUpload ref="subtaskEditFileUploadRef" mode="basic" accept=".pdf" :multiple="true"
                        chooseLabel="Upload" :auto="false" :customUpload="true" @select="handleSubtaskEditAttachment"
                        class="file-upload" />
                      <div v-if="subtask.attachments && subtask.attachments.length > 0" class="file-list">
                        <div v-for="(file, index) in subtask.attachments" :key="index" class="file-item">
                          <a v-if="file.url" :href="file.url" target="_blank" class="file-link">
                            <i class="pi pi-paperclip"></i> {{ file.name }}
                          </a>
                          <span v-else class="file-name pending-upload">
                            <i class="pi pi-clock"></i> {{ file.name }} <small>(uploading...)</small>
                          </span>
                          <Button icon="pi pi-times" class="p-button-danger p-button-text p-button-sm file-remove"
                            @click="removeSubtaskEditAttachment(index)" />
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="subtask-edit-actions">
                    <Button label="Save" @click="saveEditingSubtask(subtask)" class="p-button-sm" />
                    <Button label="Cancel" @click="cancelEditingSubtask" class="p-button-text p-button-sm" />
                  </div>
                </div>
              </template>

              <!-- View Mode -->
              <template v-else>
                <div class="subtask-header">
                  <h4 class="subtask-title">{{ subtask.name }}</h4>
                  <div class="subtask-meta">
                    <Dropdown v-model="subtask.status" :options="getStatusOptionsForSubtask(subtask)"
                      optionLabel="label" optionValue="value" class="subtask-status-dropdown"
                      :class="getStatusClass(subtask.status)" @change="updateSubtaskStatus(subtask, subtask.status)"
                      @click.stop />
                    <span class="priority-badge" :class="getPriorityClass(subtask.priority)">P{{ subtask.priority
                      }}</span>
                  </div>
                </div>
                <p v-if="subtask.description" class="subtask-description">{{ subtask.description }}</p>
                <div class="subtask-details">
                  <div class="subtask-meta-row">
                    <span v-if="subtask.due_date" class="subtask-due"><i class="pi pi-calendar-times"></i> {{ formatDate(subtask.due_date) }} <span class="relative-time">({{ formatDateRelative(subtask.due_date) }})</span></span>
                    <span v-if="subtask.start_date" class="subtask-start"><i class="pi pi-calendar-plus"></i> Started: {{ formatDate(subtask.start_date) }}</span>
                    <span class="subtask-owner">üë§ {{ getOwnerName(subtask.owner) }}</span>
                    <span v-if="subtask.collaborators && subtask.collaborators.length > 0" class="subtask-collabs">
                      ü§ù {{ getCollaboratorNames(subtask.collaborators) }}
                    </span>
                  </div>

                  <!-- Attachments on separate row but same size -->
                  <div v-if="subtask.attachments && subtask.attachments.length > 0" class="subtask-attachments-row">
                    <span class="subtask-attachments">
                      <i class="pi pi-paperclip"></i>
                      <span v-for="(attachment, idx) in subtask.attachments" :key="idx">
                        <a :href="attachment.url" target="_blank" class="subtask-attachment-link">{{ attachment.name
                          }}</a>
                        <span v-if="idx < subtask.attachments.length - 1"> </span>
                      </span>
                    </span>
                  </div>
                </div>

                <!-- Edit button for parent task owner -->
                <div v-if="isEditing && canEdit(selectedTask)" class="subtask-actions">
                  <Button label="Edit" icon="pi pi-pencil" @click="startEditingSubtask(subtask)"
                    class="p-button-text p-button-sm" />
                </div>
              </template>
            </div>
          </div>
        </div>

        <div v-else-if="!showSubtaskForm" class="no-subtasks">
          <span>No subtasks yet</span>
        </div>
      </div>

      <div class="save-btn-container">
        <template v-if="selectedTask && !isEditing && canEdit(selectedTask)">
          <Button label="Edit" type="button" class="save-task-btn" @click="startEditing" />
        </template>
        <Button label="Save" type="button" class="save-task-btn" @click="saveTask" v-if="isEditing || !selectedTask"
          :disabled="!canEdit(selectedTask)" />
      </div>

    </div>
  </form>
</Dialog>
